<html>
<style>
.base {
clear:left;
width:256pt;
padding:5pt;
}
.number {
display:block;
clear:left;
width:100%;
}
#ChooseBase {
width:32pt;
}
.character {
display:block;
width:16pt;
float:left;
}
</style>
<h3>Mathematical Baseball</h3>
<div id="DivInput"></div>
<div id="DivStack"></div>
<script>
var separator = '.';
var base = [
    // keep Decimal first
    { name : "Decimal", value : 10, characters : [ '0', '1', '2', '3', '4', '5', '6', '7', '8', '9' ], 
      lookup : { '0' : [0], '1': [1], '2' : [2], '3' : [3], '4' : [4], '5' : [5], '6' : [6], '7' : [7], '8' : [8], '9' : [9] } },
    { name : "Octal", value : 8, characters : [ '0', '1', '2', '3', '4', '5', '6', '7' ],
      lookup : { '0' : [0], '1': [1], '2' : [2], '3' : [3], '4' : [4], '5' : [5], '6' : [6], '7' : [7] } },
    { name : "Hexadecimal", value : 16, characters : [ '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f' ],
      lookup : { '0' : [0], '1': [1], '2' : [2], '3' : [3], '4' : [4], '5' : [5], '6' : [6], '7' : [7], '8' : [8], '9' : [9], 'a' : [10], 'b' : [11], 'c' : [12], 'd' : [13], 'e' : [14], 'f' : [15] } },
    { name : "Binary", value : 2, characters : [ '0', '1' ],
      lookup : { '0' : [0], '1': [1] } },
    { name : "Ternary", value : 3, characters : [ '0', '1', '2' ],
      lookup : { '0' : [0], '1': [1], '2' : [2] } },
    { name : "Dozenal", value : 12, characters : [ '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'X', 'N' ],
      lookup : { '0' : [0], '1': [1], '2' : [2], '3' : [3], '4' : [4], '5' : [5], '6' : [6], '7' : [7], '8' : [8], '9' : [9], 'X' : [10], 'N' : [11] } },
    { name : "Balanced Ternary", value : -1, characters : [ 'O', 'M', 'P' ],
      lookup : { 'O' : [0], 'M': [-1], 'P' : [1] } },
    { name : "Choose", value : 6, characters : [ '0', '1', '2', '3', '4', '5' ],
      lookup : { '0' : [0], '1': [1], '2' : [2], '3' : [3], '4' : [4], '5' : [5] } }
];
var DefaultCharacters = [ 
    '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 
    'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z',
    'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
    '_', '!', '@', '$', '(', ')', '[', ']', '{', '}'
];
function error(msg) {
    console.error(msg);
}
var stack = [];
function stack_alert(msg) {
    if (msg)
        console.log("current stack", stack, "after", msg);
    else
        console.log("current stack", stack);
}
var Operators = {
    '*' : function () {
        if (stack.length <= 1)
            return error("Not enough numbers on stack, this is POSTFIX (use \"3 4 *\").");
        stack[stack.length-2] *= stack[stack.length-1];
        stack.pop();
        stack_alert("*");
    },
    '/' : function () {
        if (stack.length <= 1)
            return error("Not enough numbers on stack, this is POSTFIX (use \"3 4 /\").");
        stack[stack.length-2] /= stack[stack.length-1];
        stack.pop();
        stack_alert("/");
    },
    '+' : function () {
        if (stack.length <= 1)
            return error("Not enough numbers on stack, this is POSTFIX (use \"3 4 +\").");
        stack[stack.length-2] += stack[stack.length-1];
        stack.pop();
        stack_alert("+");
    },
    '-' : function () {
        if (stack.length <= 1)
            return error("Not enough numbers on stack, this is POSTFIX (use \"3 4 -\").");
        stack[stack.length-2] -= stack[stack.length-1];
        stack.pop();
        stack_alert("-");
    }
};
function calculate(msg, i) {
    stack.length = 0;
    console.log("got blur", i, "; msg = ", msg);
    var j = 0;
    while (j < msg.length) {
        if (msg[j] == ' ') {
            ++j;
            continue;
        }
        var sign = 1;
        if ((msg[j] == '-') && (j+1 < msg.length) && (msg[j+1] == separator || base[i].lookup[msg[j+1]] !== undefined)) {
            sign = -1; 
            ++j;
        }
        if (msg[j] == separator || base[i].lookup[msg[j]] !== undefined) {
            // build the result, we got a digit
            var baseMultiple = base[i].value < 0 ? 1-2*base[i].value : base[i].value;
            var result;
            if (msg[j] == separator) {
                result = 0;
                ++j;
            } else {
                result = base[i].lookup[msg[j]][Math.floor(Math.random()*base[i].lookup[msg[j]].length)];
                ++j;
                while (j < msg.length && base[i].lookup[msg[j]] !== undefined) {
                    result *= baseMultiple;
                    result += base[i].lookup[msg[j]][Math.floor(Math.random()*base[i].lookup[msg[j]].length)];
                    ++j;
                }
                if (j >= msg.length || msg[j] != separator) {
                    stack.push(result*sign);
                    stack_alert("");
                    continue;
                }
                // otherwise, we have a period, so go past that
                ++j;
            }
            var below = 1.0;
            while (j < msg.length && base[i].lookup[msg[j]] !== undefined) {
                below /= baseMultiple;
                result += base[i].lookup[msg[j]][Math.floor(Math.random()*base[i].lookup[msg[j]].length)]*below;
                ++j;
            }
            stack.push(result*sign);
            stack_alert("");
        } else  {
            var fn = Operators[msg[j]];
            if (fn === undefined) {
                error("Unknown letter: "+msg[j]);
                ++j;
                continue;
            }
            fn();
            ++j;
        }
    }
    var nextResult = 0;
}
function write(i, value) {
    var buffer = [];
    if (value == 0) {
        buffer.push(base[i].characters[0]);
    } else if (base[i].value < 0) { // balanced
        // TODO: do balanced arithmetic
    } else { // normal
        if (value < 0) {
            buffer.push('-');
            value *= -1;
        }
        var copy = Math.floor(value);
        while (copy > 0) {
            buffer.push('?');
            copy = Math.floor(copy / base[i].value);
        }
        var j = buffer.length;
        copy = Math.floor(value);
        value -= copy;
        while (copy > 0) {
            buffer[--j] = base[i].characters[copy % base[i].value];
            copy = Math.floor(copy / base[i].value);
        }
        if (value) {
            buffer.push('.');
            while (value && buffer.length < 18) {
                value *= base[i].value;
                var digit = Math.floor(value);
                buffer.push(digit);
                value -= digit;
            }
        }
    }
    return buffer.join("");
}
function newCharacterInput(i, j) {
    var input = document.createElement("input");
    input.type = "text";
    input.maxLength = 1;
    input.className = "character";
    if (j >= base[i].characters.length) {
        input.value = DefaultCharacters[j];
    } else {
        input.value = base[i].characters[j]
    }
    input.onblur = function () {
        var v = input.value[0];
        if (Operators[v] !== undefined) {
            error("Don't use an operator */+- to define a character.");
            v = DefaultCharacters[j];
        }
        if (j >= base[i].characters.length) {
            while (base[i].characters.length < j) {
                base[i].characters.push(DefaultCharacters[base[i].characters.length]);
            }
            base[i].characters.push(v);
        } else {
            base[i].characters[j] = v;
        }
        base[i].lookup = {};
        var baseMultiple;
        if (base[i].value < 0) {
            base[i].lookup[base[i].characters[0]] = [0];
            for (var j=1; j <= -base[i].value; ++j) {
                if (base[i].lookup[base[i].characters[2*j-1]] === undefined)
                    base[i].lookup[base[i].characters[2*j-1]] = [-j];
                else
                    base[i].lookup[base[i].characters[2*j-1]].push(-j);
                if (base[i].lookup[base[i].characters[2*j]] === undefined)
                    base[i].lookup[base[i].characters[2*j]] = [j];
                else
                    base[i].lookup[base[i].characters[2*j]].push(j);
            }
        } else {
            for (var j=0; j < base[i].value; ++j) {
                if (base[i].lookup[base[i].characters[j]] === undefined)
                    base[i].lookup[base[i].characters[j]] = [j];
                else
                    base[i].lookup[base[i].characters[j]].push(j);
            }
        }
    }
    return input;
}
function newBaseInput(i) {
    var div = document.createElement("div");
    div.className = "base";
    if (base[i].value == 0 || base[i].value == 1) {
        error("bad base, need base < 0 or base > 1");
        return div;     
    }
    var label = document.createElement("label");
    var input = document.createElement("input");
    input.type = "text";
    input.value = "";
    input.className = "number";
    label.innerHTML = base[i].name + ":";
    input.id = label.for = "Input"+base[i].name;
    input.onblur = function () { 
        calculate(input.value, i); 
        if (stack.length === 0) {
            error("nothing in the stack.");
            return;
        } else if (stack.length > 1) {
            error("more than one thing left in the stack, taking last element.");
        }
        var value = stack[stack.length-1];
        console.log("writing value", value, "to all");
        for (var j=0; j<base.length; ++j) {
            document.getElementById("Input"+base[j].name).value = write(j, value);
        }
    };
    div.appendChild(label);
    div.appendChild(input);
    var characters = document.createElement("div");
    var count = base[i].value < 0 ? 1-2*base[i].value : base[i].value;
    for (var j=0; j<count; ++j) {
        characters.appendChild(newCharacterInput(i, j));
    }
    if (base[i].name === "Choose") {
        label = document.createElement("label");
        label.for = "ChooseBase";
        label.innerHTML = "Base:&nbsp;&nbsp;";
        input = document.createElement("input");
        input.type = "text";
        input.id = "ChooseBase";
        input.value = base[i].value;
        input.onblur = function () {
            var val = parseInt(input.value);
            if (isNaN(val) || val == 0 || val == 1) {
                error("bad base value (pick < 0 for balanced, or > 1 for regular)");
                input.value = base[i].value;
                return;
            }
            if (val > DefaultCharacters.length) {
                input.value = val = DefaultCharacters.length;
            }
            var count = val < 0 ? 1-2*val : val;
            var oldCount = base[i].value < 0 ? 1-2*base[i].value : base[i].value;
            var diff = count - oldCount;
            base[i].value = val;
            if (diff === 0) {
                return;
            } else if (diff < 0) {
                while (diff < 0) {
                    characters.removeChild(characters.lastChild);
                    ++diff;
                }
                return;
            }
            while (diff > 0) {
                characters.appendChild(newCharacterInput(i, oldCount));
                ++oldCount;
                --diff;
            }
        }
        div.appendChild(label);
        div.appendChild(input);
    }
    div.append(characters);
    return div;
}
var DivInput = document.getElementById("DivInput");
for (var i=0; i<base.length; ++i) {
    DivInput.appendChild(newBaseInput(i));
}
document.onkeydown = function(evt) {
  if (evt.keyCode == 27) {
    document.activeElement.blur(); // defocus from current element
  } else if (evt.keyCode == 13) { // if we press enter...
    // don't let enter execute submit
    evt.preventDefault();
    document.activeElement.blur(); // defocus from current element
    return false;
  }
};
</script>
</html>
